<!DOCTYPE html>
<html>

<head>
    <title>Application Resilience Demo</title>
    <script src="https://animejs.com/lib/anime.min.js"></script>
    <script src="Network.js"></script>
    <script>
        function LoadGenerator() {
            this.rps = 1;
            this._intervalId = 0;
            this.recvCount = 0;
            this.errCount = 0;

            this.setRequestsPerSecond = function (rps) {
                clearInterval(this._intervalId);
                this.rps = rps;
                this._intervalId = setInterval(this.sendMessage.bind(this), (1000 / this.rps));
            }

            this.sendMessage = function () {
                this.netsend({ data: new NetworkRequest('gateway', 'load-generator') });
            }

            this.start = function () {
                this._intervalId = setInterval(this.sendMessage.bind(this), (1000 / this.rps));
            };

            this.addEventListener = function (evtype, handler) {
                this.netsend = handler;
            }

            this.postMessage = function (msg) {
                if (msg.to == 'load-generator') {
                    this.recvCount++;
                }
            }
        }

        function onLoad() {
            // anime({
            //     targets: '.message',
            //     translateX: 250,
            //     loop: true,
            //     direction: 'alternate',
            //     easing: 'easeInOutSine'
            // });

            network = new Network();
            network.latency = 1;
            network.jitter = 1;

            datasvr = new Worker('datasvr.js');
            appsvr = new Worker('appsvr.js');
            websvr = new Worker('websvr.js');
            gateway = new Worker('gateway.js');

            gateway.addEventListener('message', (msg) => {
                if (msg.data.node == 'gateway') {
                    console.log('Gateway Stats');
                    console.log(msg.data.stats);
                }
            })

            network.addNode("data-server", datasvr);
            network.addNode("app-server", appsvr);
            network.addNode("web-server", websvr);
            network.addNode("gateway", gateway);

            loadgen = new LoadGenerator();
            network.addNode('load-generator', loadgen);
            loadgen.start();
        }
    </script>
    <script>
        function Request() {
            this.success = false;
        }

        function Node(dependency = null) {
            this.errorCount = 0;
            this.rqstRecvCount = 0;
            this.respSentCount = 0;
            this.rqstSentCount = 0;
            this.respRecvCount = 0;
            this.dependency = dependency;

            this.execute = function (request) {
                execResult = true;
                this.rqstRecvCount++;

                if (this.dependency) {
                    rqst = new Request();
                    this.rqstSentCount++;
                    this.dependency.execute(rqst);
                    this.respRecvCount++;
                    execResult = rqst.success;
                } else {
                    if (Math.random() > 0.5) {
                        execResult = false;
                    }
                }

                if (request) {
                    this.respSentCount++;
                    request.success = execResult;
                } else {
                    console.log(execResult);
                }
            }
        }
    </script>
    <style>
        div#demoScreen {
            width: auto;
            height: 400px;
            border: 2px solid black;
            background-color: gray;
            display: grid;
            justify-content: space-evenly;
            align-content: space-evenly;
            grid-template-columns: auto auto auto auto;
        }

        span.node {
            height: 100px;
            width: 100px;
            border-radius: 50%;
            display: inline-block;
            background-color: goldenrod;
        }

        span#clientNode {
            background-color: #cecece;
        }

        span.message {
            background-color: green;
            width: 35px;
            height: 20px;
            display: absolute;
            left: 100px;
            top: 75px;
        }
    </style>
</head>

<body onload="onLoad();">
    <div id="demoScreen">
        <span id="clientNode" class="node">Client</span>
        <span id="gatewayNode" class="node">Node 1</span>
        <span id="appNode" class="node">Node 2</span>
        <span id="dataNode" class="node">Node 3</span>
        <span class="message">msg</span>
    </div>
</body>

</html>